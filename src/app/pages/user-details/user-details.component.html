<!-- Main container for the page -->
<div class="p-6">
  @if (isLoading()) {
  <p class="text-center text-slate-500">Loading user details...</p>
  } @else if (error()) {
  <!-- Error State -->
  <div
    class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"
    role="alert"
  >
    <strong class="font-bold">Error:</strong> {{ error() }}
    <div class="mt-4">
      <a
        routerLink="/users"
        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
        >Back to Users</a
      >
    </div>
  </div>
  } @else { @if (user(); as user) {

  <!--     1. USER DISPLAY SECTION         -->
  <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <div class="flex items-center gap-4">
      <img
        [src]="user.image"
        alt="User Avatar"
        class="w-16 h-16 rounded-full border-2 border-blue-500"
      />
      <div>
        <h2 class="text-3xl font-bold">
          {{ user.firstName }} {{ user.lastName }}
        </h2>
        <p class="text-slate-500 dark:text-slate-400">
          {{ "@" + user.username }}
        </p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button
        (click)="goBack()"
        class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600"
      >
        Back
      </button>
      <button
        (click)="openEditModal()"
        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
      >
        Edit User
      </button>
    </div>
  </div>

  <!-- UPDATED User Details Card -->
  <div
    class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md border dark:border-slate-700"
  >
    <h3 class="text-xl font-semibold mb-4 border-b pb-2 dark:border-slate-700">
      User Information
    </h3>
    <dl class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6">
      <!-- Personal Info -->
      <div class="flex flex-col">
        <dt class="field-label">Email Address</dt>
        <dd class="field-value">
          <a href="mailto:{{ user.email }}" class="hover:underline">{{
            user.email
          }}</a>
        </dd>
      </div>
      <div class="flex flex-col">
        <dt class="field-label">Phone</dt>
        <dd class="field-value">{{ user.phone }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="field-label">Gender</dt>
        <dd class="field-value capitalize">{{ user.gender }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="field-label">Birth Date</dt>
        <dd class="field-value">{{ user.birthDate }}</dd>
      </div>
      <!-- Location Info -->
      <div class="flex flex-col">
        <dt class="field-label">City</dt>
        <dd class="field-value">{{ user.address.city }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="field-label">State</dt>
        <dd class="field-value">{{ user.address.state }}</dd>
      </div>
      <!-- Company Info -->
      <div class="flex flex-col">
        <dt class="field-label">Company</dt>
        <dd class="field-value">{{ user.company.name }}</dd>
      </div>
    </dl>
  </div>

  <!--         2. EDIT MODAL               -->
  @if (isEditModalOpen()) {
  <div
    (click)="closeEditModal()"
    class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4"
  >
    <div
      (click)="$event.stopPropagation()"
      class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl z-50"
    >
      <div
        class="flex justify-between items-center border-b pb-3 dark:border-slate-700"
      >
        <h3 class="text-xl font-semibold">Edit User Details</h3>
        <button
          (click)="closeEditModal()"
          class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"
        >
          &times;
        </button>
      </div>
      <!-- UPDATED Edit Form -->
      <form
        [formGroup]="editForm"
        (ngSubmit)="onSaveChanges()"
        class="mt-4 space-y-4 max-h-[70vh] overflow-y-auto pr-2"
      >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="firstName" class="form-label font-semibold"
              >First Name: </label
            ><input
              type="text"
              id="firstName"
              formControlName="firstName"
              class="form-input"
            />
          </div>
          <div>
            <label for="lastName" class="form-label font-semibold"
              >Last Name: </label
            ><input
              type="text"
              id="lastName"
              formControlName="lastName"
              class="form-input"
            />
          </div>
        </div>
        <div>
          <label for="username" class="form-label font-semibold"
            >Username: </label
          ><input
            type="text"
            id="username"
            formControlName="username"
            class="form-input"
          />
        </div>
        <div>
          <label for="email" class="form-label font-semibold">Email: </label
          ><input
            type="email"
            id="email"
            formControlName="email"
            class="form-input"
          />
        </div>
        <div>
          <label for="phone" class="form-label font-semibold">Phone: </label
          ><input
            type="tel"
            id="phone"
            formControlName="phone"
            class="form-input"
          />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="gender" class="form-label font-semibold">Gender: </label
            ><input
              type="text"
              id="gender"
              formControlName="gender"
              class="form-input"
            />
          </div>
          <div>
            <label for="birthDate" class="form-label font-semibold"
              >Birth Date: </label
            ><input
              type="date"
              id="birthDate"
              formControlName="birthDate"
              class="form-input"
            />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="city" class="form-label font-semibold">City: </label
            ><input
              type="text"
              id="city"
              formControlName="city"
              class="form-input"
            />
          </div>
          <div>
            <label for="state" class="form-label font-semibold">State: </label
            ><input
              type="text"
              id="state"
              formControlName="state"
              class="form-input"
            />
          </div>
        </div>
        <div>
          <label for="companyName" class="form-label font-semibold"
            >Company Name: </label
          ><input
            type="text"
            id="companyName"
            formControlName="companyName"
            class="form-input"
          />
        </div>
        <div
          class="mt-6 flex justify-end gap-3 border-t pt-4 dark:border-slate-700"
        >
          <button
            type="button"
            (click)="closeEditModal()"
            class="px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500"
          >
            Cancel
          </button>
          <button
            type="submit"
            [disabled]="editForm.invalid"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-slate-400 dark:disabled:bg-slate-500"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
  } } @else {
  <p class="text-center text-slate-500">User not found.</p>
  } }

  <div class="mt-8">
    <h3 class="text-2xl font-bold mb-4">User Posts</h3>

    @if (arePostsLoading()) {
    <p class="text-slate-500">Loading posts...</p>
    } @else if (postsError()) {
    <p class="text-red-500 italic">{{ postsError() }}</p>
    } @else if (posts().length > 0) {
    <div
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"
    >
      @for (post of posts(); track post.id) {
      <app-post-card [post]="post"></app-post-card>
      }
    </div>
    } @else {
    <!-- This handles the case where the API call was successful but returned no posts -->
    <p class="text-slate-500 italic">No posts found for this user.</p>
    }
  </div>
</div>

<div
  class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"
></div>
